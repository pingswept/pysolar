
// data for city marker sets

USCities = [
	{name: "Anchorage, AK",     lat: 61.217, lng: -149.90,  zone:  -9},
	{name: "Atlanta, GA",       lat: 33.733, lng: -84.383,  zone:  -5},
	{name: "Bismarck, ND",      lat: 46.817, lng: -100.783, zone:  -6},
	{name: "Boston, MA",        lat: 42.35,  lng: -71.05,   zone:  -5},
	{name: "Chicago, IL",       lat: 41.85,  lng: -87.65,   zone:  -6},
	{name: "Dallas, TX",        lat: 32.78,  lng: -96.80,   zone:  -6},
	{name: "Denver, CO",        lat: 39.74,  lng: -104.99,  zone:  -7},
	{name: "Detroit, MI",       lat: 42.333, lng: -83.05,   zone:  -5},
	{name: "Honolulu, HI",      lat: 21.30,  lng: -157.85,  zone: -10},
	{name: "Los Angeles, CA",   lat: 34.05,  lng: -118.23,  zone:  -8},
	{name: "Omaha, NE",         lat: 41.26,  lng: -95.95,   zone:  -6},
	{name: "Miami, FL",         lat: 25.77,  lng: -80.18,   zone:  -5},
	{name: "Minneapolis, MN",   lat: 44.97,  lng: -93.25,   zone:  -6},
	{name: "New Orleans, LA",   lat: 29.95,  lng: -90.07,   zone:  -6},
	{name: "New York City, NY", lat: 40.72,  lng: -74.02,   zone:  -5},
	{name: "Phoenix, AZ",       lat: 33.43,  lng: -112.07,  zone:  -7},
	{name: "Portland, OR",      lat: 45.52,  lng: -122.65,  zone:  -8},
	{name: "Raleigh, NC",       lat: 35.78,  lng: -78.65,   zone:  -5},
	{name: "Saint Louis, MO",   lat: 38.62,  lng: -90.18,   zone:  -6},
	{name: "Salt Lake City, UT",lat: 40.77,  lng: -111.89,   zone: -7},
	{name: "San Francisco, CA", lat: 37.77,  lng: -122.42,  zone:  -8},
	{name: "Seattle, WA",       lat: 47.60,  lng: -122.32,  zone:  -8},
	{name: "Washington DC",     lat: 38.88,  lng: -77.03,   zone:  -5},
];



var WorldCities = [
	{name: "Adelaide, SA, Australia",    lat: -34.925, lng: 138.60,   zone:  9.5},
	{name: "Addis Ababa, Ethiopia",      lat: 9.01,    lng: 38.758,   zone:  3},
	{name: "Astana, Kazakhstan",         lat: 51.183,  lng:  71.45,   zone:  6},
	{name: "Auckland, New Zealand",      lat: -36.847, lng: 174.77,   zone: 12},
	{name: "Baku, Azerbaijan",           lat: 40.417,  lng: 49.825,   zone:  4},
	{name: "Bangkok, Thailand",          lat: 13.725,  lng: 100.475,  zone:  7},
	{name: "Beijing, China",             lat: 39.92,   lng: 116.42,   zone:  8},
	{name: "Berlin, Germany",            lat: 52.33,   lng: 13.30,    zone:  1},
	{name: "Bombay, India",              lat: 18.93,   lng: 72.83,    zone:  5.5},
	{name: "Buenos Aires, Argentina",    lat: -34.60,  lng: -58.45,   zone: -3},
	{name: "Cairo, Egypt",               lat: 30.10,   lng: 31.37,    zone:  2},
	{name: "Caracas, Venezuela",         lat: 10.5,    lng: -66.898,  zone: -4.5},
	{name: "Cape Town, South Africa",    lat: -33.92,  lng: 18.37,    zone:  2},
	{name: "Dakar, Senegal",             lat: 14.687,  lng: -17.45,   zone:  0},
	{name: "Darwin, NT, Australia",      lat: -12.46,  lng: 130.842,  zone:  9.5},
	{name: "Edmonton, AB, Canada",       lat: 53.533,  lng: -113.494, zone: -7},
	{name: "Halifax, NS, Canada",        lat: 44.646,  lng: -63.575,  zone: -4},
	{name: "Havana, Cuba",               lat: 23.133,  lng: -82.367,  zone: -5},
	{name: "Helsinki, Finland",          lat: 60.17,   lng: 24.97,    zone:  2},
	{name: "Hong Kong, China",           lat: 22.25,   lng: 114.17,   zone:  8},
	{name: "Jerusalem, Israel",          lat: 31.78,   lng: 35.23,    zone:  2},
	{name: "Johannesburg, South Africa", lat: -26.20,  lng: 28.046,   zone:  2},
	{name: "Kabul, Afghanistan",         lat: 34.53,   lng: 69.172,   zone:  4.5},
	{name: "Karachi, Pakistan",          lat: 24.892,  lng: 67.027,   zone:  5},
	{name: "Kathmandu, Nepal",           lat: 27.70,   lng: 85.317,   zone:  5.75},
	{name: "Lagos, Nigeria",             lat: 6.442,   lng: 3.417,    zone:  1},
	{name: "Lima, Peru",                 lat: -12.092, lng: -77.047,  zone: -5},
	{name: "Lisbon, Portugal",           lat: 38.707,  lng: -9.133,   zone:  0},
	{name: "London, United Kingdom",     lat: 51.50,   lng: -0.13,    zone:  0},
	{name: "Manaus, Brazil",             lat: -3.107,  lng: -60.025,  zone: -4},
	{name: "Mexico City, Mexico",        lat: 19.4,    lng: -99.15,   zone: -6},
	{name: "Montreal, QC, Canada",       lat: 45.55,   lng: -73.633,  zone: -5},
	{name: "Moscow, Russia",             lat: 55.75,   lng: 37.58,    zone:  3},
	{name: "New Delhi, India",           lat: 28.6,    lng: 77.2,     zone:  5.5},
	{name: "Nuku alofa, Tonga",          lat: -21.133, lng: -175.217, zone: 13},
	{name: "Nuuk, Greenland",            lat: 64.183,  lng: -51.717,  zone: -3},
	{name: "Ottawa, Canada",             lat: 45.42,   lng: -75.7,    zone: -5},
	{name: "Paris, France",              lat: 48.87,   lng: 2.67,     zone:  1},
	{name: "Perth, WA, Australia",       lat: -31.955, lng: 115.858,  zone:  8},
	{name: "Reykjavik, Iceland",         lat: 64.133,  lng: -21.9,    zone:  0},
	{name: "Rio de Janeiro, Brazil",     lat: -22.90,  lng: -43.23,   zone: -3},
	{name: "Riyadh, Saudi Arabia",       lat: 24.63,   lng: 46.72,    zone:  3},
	{name: "Rome, Italy",                lat: 41.90,   lng: 12.48,    zone:  1},
	{name: "Santiago, Chile",            lat: -33.425, lng: -70.567,  zone: -4},
	{name: "Solomon Islands",            lat: -9.646,  lng: 160.375,  zone: 11},
	{name: "Stockholm, Sweden",          lat: 59.333,  lng: 18.067,   zone:  1},
	{name: "Sydney, Australia",          lat: -33.87,  lng: 151.22,   zone: 10},
	{name: "Tehran, Iran",               lat: 35.70,   lng: 51.42,    zone:  3.5},
	{name: "Tokyo, Japan",               lat: 35.70,   lng: 139.77,   zone:  9},
	{name: "Vancouver, BC, Canada",      lat: 49.267,  lng: -123.117, zone: -8},
	{name: "Vladivostok, Russia",        lat: 43.131,  lng: 131.925,  zone: 10},
	{name: "Winnipeg, MB, Canada",       lat: 49.896,  lng: -97.15,   zone: -6},
	{name: "Yangon, Myanmar",            lat: 16.783,  lng: 96.158,   zone:  6.5},
	{name: "Zurich, Switzerland",        lat: 47.38,   lng: 8.53,     zone:  1},
];

var obs = [
	{name: "Barrow, AK",             lat: 71.323,  lng: -156.611,  zone:  -9},
	{name: "Trinidad Head, CA",      lat: 41.054,  lng: -124.1508,  zone:  -8},
	{name: "Mauna Loa, HI",          lat: 19.536,  lng: -155.576,  zone: -10},
	{name: "American Samoa",         lat: -14.2474, lng: -170.5646,  zone: -11},
	{name: "South Pole, Antarctica", lat: -89.98, lng: -24.80,   zone: -12},
	{name: "Summit, Greenland",      lat: 72.5804, lng: -38.4559, zone:  -3}
];

var surfrad = [
	{name: 'Goodwin Creek, MS',  lat: 34.254, lng: -89.874,  zone: -6},
	{name: 'Fort Peck, MT',      lat: 48.311, lng: -105.103, zone: -7},
	{name: 'Bondville, IL',      lat: 40.055, lng: -88.372,  zone: -6},
	{name: 'Table Mountain, CO', lat: 40.125, lng: -105.237, zone: -7},
	{name: 'Desert Rock, NV',    lat: 36.626, lng: -116.018, zone: -8},
	{name: 'Penn State, PA',     lat: 40.72,  lng: -77.93,   zone: -5},
	{name: 'Sioux Falls, SD',    lat: 43.733, lng: -96.6233, zone: -6},
];

var sites = [
	{name: 'Arembepe, Bahia, Brazil',                    lat: -12.77,   lng: -38.17,    zone:  -3},
	{name: 'Albuquerque, NM, USA',                       lat: 35.04,    lng: -106.62,   zone:  -7},
	{name: 'Alert, Nunavut, Canada',                     lat: 82.4508,  lng: -62.5056,  zone:  -4},
	{name: 'Argyle, ME, USA',                            lat: 45.03,    lng: -68.68,    zone:  -5},
	{name: 'Arrival Heights, Antarctica, New Zealand',   lat: -77.833,  lng: 166.2,     zone: -11},
	{name: 'Ascension Island, United Kingdom',           lat: -7.92,    lng: -14.42,    zone:  -1},
	{name: 'Assekrem, Algeria',                          lat: 23.18,    lng: 5.42,      zone:   1},
	{name: 'Terceira Island, Azores, Portugal',          lat: 38.77,    lng: -27.38,    zone:  -1},
	{name: 'Baltic Sea, Poland',                         lat: 55.35,    lng: 17.22,     zone:   1},
	{name: 'Boulder Atmospheric Observatory, USA',       lat: 40.05,    lng: -105.01,   zone:  -7},
	{name: 'Bradgate, IA, USA',                          lat: 42.82,    lng: -94.41,    zone:  -6},
	{name: 'Bismarck, ND, USA',                          lat: 46.77,    lng: -100.75,   zone:   6},
	{name: 'Bukit Kototabang, Indonesia',                lat: -0.2,     lng: 100.32,    zone:   7},
	{name: 'Boulder, CO, USA',                           lat: 39.991,   lng: -105.261,  zone:  -7},
	{name: 'St. Davids Head, Bermuda, United Kingdom',   lat: 32.37,    lng: -64.65,    zone:  -4},
	{name: 'Tudor Hill, Bermuda, United Kingdom',        lat: 32.27,    lng: -64.88,    zone:  -4},
	{name: 'Nashville, TN, USA',                         lat: 36.25,    lng: -86.56,    zone:   6},
	{name: 'Bondville, IL, USA',                         lat: 40.05,    lng: -88.37,    zone:   6},
	{name: 'Beaver Crossing, NE, USA',                   lat: 40.8,     lng: -97.18,    zone:  -6},
	{name: 'Prospect Hill, Bermuda, United Kingdom',     lat: 32.308,   lng: -64.765,   zone:  -4},
	{name: 'BERMS, Saskatchewan, Canada',                lat: 54.34,    lng: -104.99,   zone:  -6},
	{name: 'Barrow, AK, USA',                            lat: 71.323,   lng: -156.6114, zone:  -9},
	{name: 'Black Sea, Constanta, Romania',              lat: 44.17,    lng: 28.68,     zone:   2},
	{name: 'Briggsdale, CO, USA',                        lat: 40.37,    lng: -104.3,    zone:  -7},
	{name: 'Cold Bay, AK, USA',                          lat: 55.21,    lng: -162.72,   zone:  -9},
	{name: 'Caribou, ME, USA',                           lat: 46.87,    lng: -68.02,    zone:   5},
	{name: 'Cape Grim, Tasmania, Australia',             lat: -40.683,  lng: 144.69,    zone:  10},
	{name: 'Cape May, NJ, USA',                          lat: 38.83,    lng: -74.32,    zone:  -5},
	{name: 'Cape San Juan, Puerto Rico, USA',            lat: 18.3811,  lng: -65.6177,  zone:   0},
	{name: 'Cape Point, South Africa',                   lat: -34.35,   lng: 18.49,     zone:   2},
	{name: 'Crozet Island, France',                      lat: -46.45,   lng: 51.85,     zone:   5},
	{name: 'Dahlen, ND, USA',                            lat: 48.38,    lng: -99,       zone:  -6},
	{name: 'Desert Rock, NV, USA',                       lat: 36.63,    lng: -116.02,   zone:  -8},
	{name: 'Easter Island, Chile',                       lat: -27.15,   lng: -109.45,   zone:  -7},
	{name: 'Estevan Point,  British Columbia, Canada',   lat: 49.5833,  lng: -126.3667, zone:  -8},
	{name: 'Fairbanks, AK, USA',                         lat: 64.86,    lng: -147.85,   zone:  -9},
	{name: 'Fort Peck, MT, USA',                         lat: 48.31,    lng: -105.1,    zone:  -7},
	{name: 'Fairchild, WI, USA',                         lat: 44.66,    lng: -90.96,    zone:  -6},
	{name: 'Goodwin Creek, MS, USA',                     lat: 34.25,    lng: -89.87,    zone:  -5},
	{name: 'Conejo, Mexico',                             lat: 18.72,    lng: -95.63,    zone:  -6},
	{name: 'Mariana Islands, Guam',                      lat: 13.43,    lng: 144.78,    zone:  10},
	{name: 'Molokai Island, HI, USA',                    lat: 21.23,    lng: -158.95,   zone: -10},
	{name: 'Halley Station, Antarctica, United Kingdom', lat: -75.58,   lng: -26.5,     zone:  -2},
	{name: 'Harvard Forest, MA, USA',                    lat: 42.5378,  lng: -72.1714,  zone:  -5},
	{name: 'Hilo, HI, USA',                              lat: 19.52,    lng: -154.82,   zone:  10},
	{name: 'Homer, IL, USA',                             lat: 40.07,    lng: -87.91,    zone:  -6},
	{name: 'Hanford, CA, USA',                           lat: 36.31,    lng: -119.63,   zone:   8},
	{name: 'Hohenpeissenberg, Germany',                  lat: 47.8,     lng: 11.01,     zone:   1},
	{name: 'Hegyhatsal, Hungary',                        lat: 46.95,    lng: 16.65,     zone:   1},
	{name: 'Huntsville, AL, USA',                        lat: 34.72,    lng: -86.64,    zone:   5},
	{name: 'Storhofdi, Vestmannaeyjar, Iceland',         lat: 63.34,    lng: -20.29,    zone:   0},
	{name: 'Tenerife, Canary Islands, Spain',            lat: 28.3,     lng: -16.48,    zone:   0},
	{name: 'Key Biscayne, FL, USA',                      lat: 25.67,    lng: -80.2,     zone:  -5},
	{name: 'Kpuszta, Keszcemet, Hungary',                lat: 46.97,    lng: 19.55,     zone:   0},
	{name: 'Cape Kumukahi, HI, USA',                     lat: 19.52,    lng: -154.82,   zone: -10},
	{name: 'Kwajalein, Marshall Islands',                lat: 8.72,     lng: 167.72,    zone:   0},
	{name: 'Sary Taukum, Kazakhstan',                    lat: 44.0839,  lng: 76.8712,   zone:   6},
	{name: 'Plateau Assy, Kazakhstan',                   lat: 43.25,    lng: 77.88,     zone:   6},
	{name: 'Lauder, New Zealand',                        lat: -45.04,   lng: 169.68,    zone:  12},
	{name: 'Park Falls, WI, USA',                        lat: 45.93,    lng: -90.27,    zone:  -6},
	{name: 'Lac La Biche, Alberta, Canada',              lat: 54.95,    lng: -112.45,   zone:  -7},
	{name: 'Lulin, Taiwan',                              lat: 23.47,    lng: 120.87,    zone:   8},
	{name: 'Lampedusa, Italy',                           lat: 35.52,    lng: 12.62,     zone:   2},
	{name: 'Mex High Altitude Global Climate Obs Ctr',   lat: 19.98,    lng: -97.17,    zone:  -6},
	{name: 'Mace Head, County Galway, Ireland',          lat: 53.33,    lng: -9.9,      zone:   0},
	{name: 'Sand Island, Midway, USA',                   lat: 28.21,    lng: -177.38,   zone: -11},
	{name: 'Mt. Kenya, Kenya',                           lat: -0.05,    lng: 37.3,      zone:   3},
	{name: 'Mauna Loa, HI, USA',                         lat: 19.5362,  lng: -155.5763, zone: -10},
	{name: 'Maracompoche, Peru',                         lat: -11.4,    lng: -76.32,    zone:   5},
	{name: 'Marthas Vineyard, MA, USA',                  lat: 41.33,    lng: -70.52,    zone:  -5},
	{name: 'Nome, AK, USA',                              lat: 64.3,     lng: -165.26,   zone:   0},
	{name: 'Worcester, MA, USA',                         lat: 42.95,    lng: -70.63,    zone:  -5},
	{name: 'Narragansett, RI, USA',                      lat: 41.49,    lng: -71.42,    zone:   0},
	{name: 'Niwot Ridge, CO, USA',                       lat: 40.05,    lng: -105.58,   zone:  -7},
	{name: 'Obninsk, Russia',                            lat: 55.11,    lng: 36.6,      zone:   3},
	{name: 'Haute Provence, France',                     lat: 43.93,    lng: 5.71,      zone:  -1},
	{name: 'Oglesby, IL, USA',                           lat: 41.28,    lng: -88.94,    zone:  -6},
	{name: 'Oak Ridge, TN, USA',                         lat: 35.96,    lng: -84.29,    zone:  -5},
	{name: 'Ochsenkopf, Germany',                        lat: 50.03,    lng: 11.8,      zone:   1},
	{name: 'Pallas-Sammaltunturi, GAW Station, Finland', lat: 67.97,    lng: 24.12,     zone:   2},
	{name: 'Palmer Station, Antarctica, USA',            lat: -64.92,   lng: -64,       zone:  -3},
	{name: 'Penn State, PA, USA',                        lat: 40.72,    lng: -77.93,    zone:  -5},
	{name: 'Point Arena, CA, USA',                       lat: 38.95,    lng: -123.73,   zone:  -8},
	{name: 'Perth, Australia',                           lat: -31.93,   lng: 115.96,    zone:  -8},
	{name: 'Rowley, IA, USA',                            lat: 42.4,     lng: -91.84,    zone:  -6},
	{name: 'Ragged Point, Barbados',                     lat: 13.17,    lng: -59.43,    zone:  -4},
	{name: 'Charleston, SC, USA',                        lat: 32.77,    lng: -79.55,    zone:  -5},
	{name: 'San Jose, Costa Rica',                       lat: 9.98,     lng: -84.21,    zone:   0},
	{name: 'South Carolina Tower, USA',                  lat: 33.4057,  lng: -81.8334,  zone:  -5},
	{name: 'Mahe Island, Seychelles',                    lat: -4.67,    lng: 55.17,     zone:   4},
	{name: 'Sioux Falls, SD, USA',                       lat: 43.73,    lng: -96.62,    zone:  -6},
	{name: 'Southern Great Plains, OK, USA',             lat: 36.8,     lng: -97.5,     zone:  -6},
	{name: 'Shemya Island, AK, USA',                     lat: 52.72,    lng: 174.1,     zone: -10},
	{name: 'Tutuila, American Samoa',                    lat: -14.2474, lng: -170.5644, zone: -11},
	{name: 'St. Paul Island, AK, USA',                   lat: 57.09,    lng: -170.13,   zone:   9},
	{name: 'South Pole, Antarctica, USA',                lat: -89.98,   lng: -24.8,     zone:  12},
	{name: 'Ocean Station M, Norway',                    lat: 66,       lng: 2,         zone:   0},
	{name: 'Sutro Tower, San Francisco, CA, USA',        lat: 37.7553,  lng: -122.4517, zone:  -8},
	{name: 'Summit, Greenland',                          lat: 72.58,    lng: -38.48,    zone:  -2},
	{name: 'Sterling, VA, USA',                          lat: 38.98,    lng: -77.47,    zone:  -5},
	{name: 'Syowa Station, Antarctica, Japan',           lat: -69,      lng: 39.58,     zone:   3},
	{name: 'Tae-ahn Peninsula, Republic of Korea',       lat: 36.73,    lng: 126.13,    zone:   9},
	{name: 'Tierra Del Fuego, Ushuaia, Argentina',       lat: -54.87,   lng: -68.48,    zone:  -4},
	{name: 'Sinton, TX, USA',                            lat: 27.73,    lng: -96.86,    zone:  -6},
	{name: 'Trinidad Head, CA, USA',                     lat: 41.054,   lng: -124.15,   zone:  -8},
	{name: 'Ulaanbaatar, Mongolia',                      lat: 47.4,     lng: 106,       zone:   8},
	{name: 'Ushuaia Observatory, Argentina',             lat: -54.82,   lng: -68.33,    zone:   0},
	{name: 'Wendover, UT, USA',                          lat: 39.9,     lng: -113.72,   zone:  -7},
	{name: 'Ulaan Uul, Mongolia',                        lat: 44.45,    lng: 111.1,     zone:   8},
	{name: 'Cartersville, GA, USA',                      lat: 32.91,    lng: -79.36,    zone:  -5},
	{name: 'Wallops Island, VA, USA',                    lat: 37.86,    lng: -75.51,    zone:   5},
	{name: 'West Branch, IA, USA',                       lat: 41.725,   lng: -91.353,   zone:  -6},
	{name: 'Walnut Grove, CA, USA',                      lat: 38.265,   lng: -121.4911, zone:  -8},
	{name: 'Sede Boker, Negev Desert, Israel',           lat: 31.13,    lng: 34.88,     zone:   2},
	{name: 'Moody, TX, USA',                             lat: 31.32,    lng: -97.33,    zone:  -6},
	{name: 'Mt. Waliguan, Peoples Republic of China',    lat: 36.2879,  lng: 100.8964,  zone:   8},
	{name: 'Ny-Alesund, Svalbard, Norway and Sweden',    lat: 78.9,     lng: 11.88,     zone:   1},
];


var lineSunrise;
var lineSunset;
var lineAzimuth;


var redIcon = new L.icon({ iconUrl: './012.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var yelIcon = new L.icon({ iconUrl: './036.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var grnIcon = new L.icon({ iconUrl: './078.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var bluIcon = new L.icon({ iconUrl: './149.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var purIcon = new L.icon({ iconUrl: './172.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var gryIcon = new L.icon({ iconUrl: './215.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var whtIcon = new L.icon({ iconUrl: './216.small.png', iconSize: [10, 17], iconAnchor: [4, 17] });
var bigIcon = new L.icon({ iconUrl: './red-dot.png',   iconSize: [32, 32], iconAnchor: [16, 32] });


var cookee = GetCookie("lat")
var startLat = (cookee) ? cookee : "39.833"
cookee = GetCookie("lng")
var startLng = (cookee) ? cookee : "-98.583"
cookee = GetCookie("gmt")
var startZone = (cookee) ? cookee : "-7"


// the different map layers
mqMap = L.esri.basemapLayer('Streets');
landMap = L.esri.basemapLayer('Imagery');
topoMap = L.esri.basemapLayer('Topographic');
geoMap = L.esri.basemapLayer('NationalGeographic');

var baseLayers = {
	"Map": mqMap,
	"Satellite": landMap,
	"Topographic": topoMap,
	"Geographic": geoMap,
};

// Create the map
var map = L.map('map_canvas', {		// div id holding map
	layers: [mqMap],		// default map
	worldCopyJump: true,		// move markers if scrolling horizontally across new map
	minZoom: 1,			// minimum zoom level, skip level 0
	zoomControl: false		// don't show zoom buttons, we're using zoomslider instead
}).setView([startLat, startLng], 3);	// center map at starting position, zoom level 3

map.addControl(new L.Control.Zoomslider());

// Add the map layer switching control
L.control.layers(baseLayers).addTo(map);

// Add the city marker sets to map
var markers=[]
addMarkers(markers, "World", WorldCities, purIcon);
addMarkers(markers, "US", USCities, bluIcon);
addMarkers(markers, "Surfrad", surfrad, redIcon);
addMarkers(markers, "Site", sites, grnIcon);
addMarkers(markers, "Obs", obs, gryIcon);

// Show the correct marker set
showMarkers();


// Create Big Marker and place in center of map
var center = map.getCenter();
var bigMarker = new L.marker(center, { icon: bigIcon, draggable:true}).addTo(map);

// catch end of drag of big marker and reset map
bigMarker.on('dragend', function() {
	var point = bigMarker.getLatLng();
	// handle marker crossing dateline
	if (point.lng < -180) { point.lng += 360; } 
	if (point.lng > 180) { point.lng -= 360; }
	$('#latbox').val(point.lat);
	$('#lngbox').val(point.lng);
	latlongChanged();
});
    


/*----------------------------------------------------------------*/
// Add city markers to map
function addMarkers(list, type, markers, icon) {

	for (var i=0; i<markers.length; i++) {
		lat = markers[i].lat;
		lng = markers[i].lng;
		zone = markers[i].zone;
		tooltip = markers[i].name;
		var mrkr = new L.marker([lat,lng], { icon: icon, title: tooltip, }).addTo(map);

		mrkr.type = type;	// save the marker set name  as 'type'
		mrkr.zone = zone;	// save the time zone for this marker
		list.push(mrkr);

		mrkr.on('click', function(e) {
			var newlatlng = this.getLatLng();
			var newlat = newlatlng.lat;
			var newlng = newlatlng.lng;
			ntz = this.zone;
			$('#latbox').val(newlat);
			$('#lngbox').val(newlng);
			if ((ntz > -13) && (ntz <= 13)) {
				$('#zonebox').val(ntz);
			}
			latlongChanged();
		});
	}
}


/*----------------------------------------------------------------*/
// show the correct city marker set and hide the others
function showMarkers() {

	// Get value of marker radio button that is on
	type = $("input[name=showpins]:checked").val();

	for (var i=0; i<markers.length; i++) {

		if (markers[i].type==type)  {
			markers[i].addTo(map);
		} else {
			map.removeLayer(markers[i]);
		}
	}
}


/*----------------------------------------------------------------*/
// Called when one of the marker set radio buttons is clicked.
// Draw the new marker set and hide the others.
function refreshMap() {
	var center = map.getCenter()
	var zoom = map.getZoom()
	map.setView(center, zoom);
	showMarkers();
}

/*----------------------------------------------------------------*/
// Called when any of the form inputs change (date, location, ...)
function inputsChanged() {
//	var center = map.getCenter()
//	map.setView(center);
	latlongChanged();
}

/*----------------------------------------------------------------*/
// Get new location, move big marker to it, recalculate 
function latlongChanged() {
	var newlat = readTextBox("latbox", 9, 0, 0, -89.9, 89.9, 0)
	var newlng = readTextBox("lngbox", 10, 0, 0, -180.0, 180.0, 0)

	newcenter = L.latLng(parseFloat(newlat), parseFloat(newlng));
	map.setView(newcenter);
	bigMarker.setLatLng(newcenter);
	clearLines();
	calculate()
}

/*----------------------------------------------------------------*/
// Remove the sunrise, sunset, azimuth lines from map
function clearLines() {
	if (lineSunrise) { map.removeLayer(lineSunrise); }
	if (lineSunset) { map.removeLayer(lineSunset); }
	if (lineAzimuth) { map.removeLayer(lineAzimuth); }
}

/*----------------------------------------------------------------*/
// Draw sunrise, sunset, azimuth lines, save object
function showLineGeodesic2(type, color, direction) {

	if ( type == "azimuth") {
	  lineAzimuth = showLineGeodesic(color, direction);
	}
	if ( type == "sunrise") {
	  lineSunrise = showLineGeodesic(color, direction);
	}
	if ( type == "sunset") {
	  lineSunset = showLineGeodesic(color, direction);
	}
}


/*----------------------------------------------------------------*/
// Draw the line as geodesic line
function showLineGeodesic(color, direction) {
    //alert("Direction = " + direction)
    //
	var zoom  = map.getZoom()
	var scale = (zoom > 3) ? 3/Math.pow(2,zoom) : 0.375
	var center = map.getCenter()
	var lat1 = degToRad(center.lat)
	var lng1 = degToRad(center.lng)
	var lat = Math.asin(Math.sin(lat1)*Math.cos(scale)+Math.cos(lat1)*Math.sin(scale)*Math.cos(degToRad(direction)))
	var dlon = -Math.atan2(Math.sin(degToRad(direction))*Math.sin(scale)*Math.cos(lat1), Math.cos(scale)-Math.sin(lat1)*Math.sin(lat))
	var lon = ( (lng1 - dlon + Math.PI) % (2*Math.PI) ) - Math.PI
	var endpt = L.latLng(radToDeg(lat), radToDeg(lon));
	var line = L.geodesic(
		[[center, endpt]], 
		{color: color, 
		 opacity: 0.6,
		 steps: 30,
		 weight: 5,
	}).addTo(map);

	return line;
}

